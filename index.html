<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Men Of Responsibility</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <nav class="main-nav">
    <ul>
      <li><a href="#home">Home</a></li>
      <li><a href="#purpose">Purpose & Bylaws</a></li>
      <li><a href="#test">Members Overview</a></li>
    </ul>
  </nav>

  <header>
    <div class="header-content">
      <h1>Men Of Responsibility</h1>
      <p class="tagline">Honour, Valor, and Chivalry</p>
    </div>
  </header>

  <main>
    <!-- Home Section -->
    <section id="home" class="section">
      <div class="section-content">
        <h2>Welcome to Our Lodge</h2>
        <div class="info-cards">
          <div class="info-card">
            <h3>Meeting Dates</h3>
            <ul>
              <li><strong>Grand Meeting of the Twins Guild</strong><br>First Saturday of February</li>
              <li><strong>Guild Meeting</strong><br>First Saturday of May</li>
              <li><strong>Guild Meeting</strong><br>First Saturday of August</li>
              <li><strong>Scorpion's Guild</strong><br>First Saturday of November</li>
            </ul>
          </div>

          <div class="info-card">
            <h3>Lodge Location</h3>
            <p>Our lodge is proudly based in <strong>Odense</strong>.</p>
          </div>

          <div class="info-card">
            <h3>Membership Requirements</h3>
            <ul>
              <li>Must be born male</li>
              <li>Must be over 18 years of age</li>
              <li>Must complete our Baptismal Ritual</li>
              <li>Must pay membership dues</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- Purpose & Bylaws Section -->
    <section id="purpose" class="section">
      <div class="section-content">
        <h2>Purpose & Bylaws</h2>
        <div class="purpose-content">
          <p>
            Our lodge aims to foster fellowship, friendship, and development among our members. We strive to create a safe environment where members can share experiences, help each other, and work together to achieve common goals. Through social events and professional activities, we strengthen both our bonds and our knowledge.
          </p>
          <div class="bylaws-download">
            <h3>Lodge Bylaws</h3>
            <div class="document-preview">
              <iframe 
                src="https://drive.google.com/file/d/108vcWiJdiOs4QD7AJqrZNkfk19o5mmid/preview" 
                width="100%" 
                height="600px"
                allow="autoplay"
                scrolling="yes"
                title="Lodge Bylaws Document">
              </iframe>
            </div>
            <a href="https://drive.google.com/file/d/108vcWiJdiOs4QD7AJqrZNkfk19o5mmid/view?usp=drivesdk" target="_blank" class="download-button">
              Open in Google Drive
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- Test Section -->
    <section id="test" class="section">
      <div class="section-content">
        <h2>Members Overview</h2>
        <div class="table-wrapper">
          <table id="csv-data-table">
            <thead>
              <!-- Headers will be dynamically populated -->
            </thead>
            <tbody id="csv-table-body">
              <!-- Table content will be dynamically populated -->
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2024 Men Of Responsibility. All rights reserved.</p>
  </footer>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    // Initialize Supabase client
    const supabaseUrl = 'https://fcklpwzxixeyxvczrylg.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZja2xwd3p4aXhleXh2Y3pyeWxnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg1MDMxODQsImV4cCI6MjA1NDA3OTE4NH0.GoOaAjBPpU03UkbEB0XNIHl44EZuh-jV8YM758_1vXw'
    const supabase = createClient(supabaseUrl, supabaseKey)

    // Password protection
    const ADMIN_PASSWORD = 'far';
    let isAuthenticated = false;

    function checkAuth() {
      if (!isAuthenticated) {
        const password = prompt('Please enter the admin password:');
        if (password === ADMIN_PASSWORD) {
          isAuthenticated = true;
          return true;
        } else {
          alert('Incorrect password');
          return false;
        }
      }
      return true;
    }

    // Make functions global
    window.addNewKnight = function() {
      if (!checkAuth()) return;
      
      const tr = document.createElement('tr');
      tr.classList.add('edit-mode');
      tr.innerHTML = `
        <td><input type="text" class="member-input" placeholder="Member name" required></td>
        <td><input type="text" class="title-input" placeholder="Title" required></td>
        <td><input type="number" class="rank-input" placeholder="Rank" required></td>
        <td class="action-cell">
          <button class="btn btn-primary" onclick="saveNewKnight(this)" aria-label="Save">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="btn-icon">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
            </svg>
          </button>
          <button class="btn btn-danger" onclick="cancelAdd(this)" aria-label="Cancel">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="btn-icon">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </td>
      `;
      document.getElementById('knights-table-body').prepend(tr);
    }

    window.saveNewKnight = async function(button) {
      if (!checkAuth()) return;
      
      const tr = button.closest('tr');
      const memberInput = tr.querySelector('.member-input');
      const titleInput = tr.querySelector('.title-input');
      const rankInput = tr.querySelector('.rank-input');

      if (!memberInput.value || !titleInput.value || !rankInput.value) {
        alert('All fields must be filled');
        return;
      }

      const knight = {
        member: memberInput.value,
        title: titleInput.value,
        rank: parseInt(rankInput.value)
      };

      try {
        const { data, error } = await supabase
          .from('knights')
          .insert([knight])
          .select();

        if (error) throw error;
        fetchKnights();
      } catch (error) {
        console.error('Error saving knight:', error);
        alert('An error occurred while saving the member');
      }
    }

    window.editKnight = function(id) {
      if (!checkAuth()) return;
      
      const tr = document.querySelector(`tr[data-id="${id}"]`);
      const member = tr.cells[0].textContent;
      const title = tr.cells[1].textContent;
      const rank = tr.cells[2].textContent;

      tr.classList.add('edit-mode');
      tr.innerHTML = `
        <td><input type="text" class="member-input" value="${member}" required></td>
        <td><input type="text" class="title-input" value="${title}" required></td>
        <td><input type="number" class="rank-input" value="${rank}" required></td>
        <td class="action-cell">
          <button class="btn btn-primary" onclick="saveEdit(${id})" aria-label="Save">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="btn-icon">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
            </svg>
          </button>
          <button class="btn btn-danger" onclick="cancelEdit(${id})" aria-label="Cancel">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="btn-icon">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </td>
      `;
    }

    window.saveEdit = async function(id) {
      if (!checkAuth()) return;
      
      const tr = document.querySelector(`tr[data-id="${id}"]`);
      const memberInput = tr.querySelector('.member-input');
      const titleInput = tr.querySelector('.title-input');
      const rankInput = tr.querySelector('.rank-input');

      if (!memberInput.value || !titleInput.value || !rankInput.value) {
        alert('All fields must be filled');
        return;
      }

      const knight = {
        member: memberInput.value,
        title: titleInput.value,
        rank: parseInt(rankInput.value)
      };

      try {
        const { error } = await supabase
          .from('knights')
          .update(knight)
          .eq('id', id);

        if (error) throw error;
        fetchKnights();
      } catch (error) {
        console.error('Error updating knight:', error);
        alert('An error occurred while updating the member');
      }
    }

    window.deleteKnight = async function(id) {
      if (!checkAuth()) return;
      
      if (confirm('Are you sure you want to delete this member?')) {
        try {
          const { error } = await supabase
            .from('knights')
            .delete()
            .eq('id', id);

          if (error) throw error;
          fetchKnights();
        } catch (error) {
          console.error('Error deleting knight:', error);
          alert('An error occurred while deleting the member');
        }
      }
    }

    window.cancelEdit = function(id) {
      fetchKnights();
    }

    window.cancelAdd = function(button) {
      button.closest('tr').remove();
    }

    function displayKnights(knights) {
      const tbody = document.getElementById('knights-table-body');
      tbody.innerHTML = '';

      knights.forEach(knight => {
        const tr = document.createElement('tr');
        tr.dataset.id = knight.id;
        tr.innerHTML = `
          <td>${knight.member}</td>
          <td>${knight.title}</td>
          <td>${knight.rank}</td>
          <td class="action-cell">
            <button class="btn btn-primary" onclick="editKnight(${knight.id})" aria-label="Edit">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="btn-icon">
                <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
              </svg>
            </button>
            <button class="btn btn-danger" onclick="deleteKnight(${knight.id})" aria-label="Delete">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="btn-icon">
                <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
              </svg>
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function fetchKnights() {
      try {
        const { data: knights, error } = await supabase
          .from('knights')
          .select('*')
          .order('rank', { ascending: false });

        if (error) throw error;
        displayKnights(knights);
      } catch (error) {
        console.error('Error fetching knights:', error);
        alert('An error occurred while fetching members');
      }
    }

    // --- CSV Data Handling ---

    async function fetchCsvData() {
      const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRRq-HmzAfEDg859l20cpbjUVWo8RX4C7dnB_Nvgk3jyI3zKFEogM_T7be_Nx0r-N2nVWf38S63I7kT/pub?gid=0&single=true&output=csv';
      // Use a CORS proxy to bypass browser restrictions when fetching from a local file
      const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(csvUrl)}`;
      try {
        // Fetch using the proxy URL
        const response = await fetch(proxyUrl);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const csvText = await response.text();
        parseAndDisplayCsv(csvText);
      } catch (error) {
        console.error('Error fetching CSV data:', error);
        alert('An error occurred while fetching the CSV data.');
        // Optionally display an error message in the table area
        const tbody = document.getElementById('csv-table-body');
        tbody.innerHTML = '<tr><td colspan="100%">Error loading data. Please try again later.</td></tr>';
      }
    }

    function parseAndDisplayCsv(csvText) {
      console.log('Raw CSV Text:', csvText); // Log raw text for debugging
      // Use regex to split by newline characters (\n or \r\n)
      const lines = csvText.trim().split(/\r?\n/);
      console.log(`Found ${lines.length} lines after splitting.`); // Log line count
      
      // Check if there are enough lines for headers and data
      if (lines.length < 3) {
          console.error("CSV data is too short or improperly formatted.");
          const tbody = document.getElementById('csv-table-body');
          tbody.innerHTML = '<tr><td colspan="100%">CSV data format error.</td></tr>';
          return;
      }

      // Headers are on the second line (index 1), skip the first line (index 0 which is just commas)
      const rawHeaders = lines[1].split(',');
      // Clean up headers (remove extra quotes or spaces if any, remove point values)
      const headers = rawHeaders.map(h => h.trim().split('=')[0].trim()).filter(h => h); // Filter out empty headers potentially caused by leading commas

      // Data starts from the third line (index 2)
      const dataRows = lines.slice(2).map(line => {
          // Basic CSV parsing, assuming no commas within fields
          return line.split(',').map(cell => cell.trim());
      });

      displayCsvData(headers, dataRows);
    }

    function displayCsvData(headers, dataRows) {
      const table = document.getElementById('csv-data-table');
      const thead = table.querySelector('thead');
      const tbody = document.getElementById('csv-table-body');

      // Clear previous content
      thead.innerHTML = '';
      tbody.innerHTML = '';

      // Populate headers
      const headerRow = document.createElement('tr');
      let medlemsscoreIndex = -1; // Keep track of the Medlemsscore column index
      headers.forEach((headerText, index) => {
        if (headerText) { // Only add non-empty headers
            const th = document.createElement('th');
            th.textContent = headerText;
            if (headerText === 'Medlemsscore') {
              medlemsscoreIndex = index; // Store the index
              th.style.borderRight = '1px solid #d4c4a6'; // Use text color for border
            }
            headerRow.appendChild(th);
        }
      });
      thead.appendChild(headerRow);

      // Populate data rows
      dataRows.forEach(rowData => {
        const tr = document.createElement('tr');
        // Ensure rowData has the same number of cells as headers
        for (let i = 0; i < headers.length; i++) {
            const td = document.createElement('td');
            const cellData = rowData[i] !== undefined ? rowData[i] : ''; // Handle potentially missing cells
            
            // Check if the current header requires bold text
            if (headers[i] === 'Medlemmer' || headers[i] === 'Medlemsscore') {
              td.innerHTML = `<strong>${cellData}</strong>`; // Use innerHTML to add strong tag
            } else {
              td.textContent = cellData;
            }

            // Center text for all columns except 'Medlemmer'
            if (headers[i] !== 'Medlemmer') {
              td.style.textAlign = 'center';
            }

            // Add vertical line after Medlemsscore column
            if (i === medlemsscoreIndex) {
              td.style.borderRight = '1px solid #d4c4a6'; // Use text color for border
            }
            
            tr.appendChild(td);
        }
        tbody.appendChild(tr);
      });
        
      if (dataRows.length === 0) {
        tbody.innerHTML = `<tr><td colspan="${headers.length || 1}">No data available.</td></tr>`;
      }
    }

    // Smooth scrolling for navigation
    document.querySelectorAll('nav a').forEach(anchor => {
      anchor.addEventListener('click', function(e) {
        e.preventDefault();
        const section = document.querySelector(this.getAttribute('href'));
        section.scrollIntoView({ behavior: 'smooth' });
      });
    });

    // Initial load
    fetchKnights();
    fetchCsvData(); // Fetch CSV data on load
  </script>
</body>
</html>
